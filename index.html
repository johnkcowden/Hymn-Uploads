<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<head>
  <title>Oak Grove Virtual Choir</title>
  <link rel="icon" href="umhLogoSmall.png" type="image/x-icon">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <style media="screen">
    .list-group-item {
      border-width: thin;
      border-color: grey;
      border-top: thin !important;
      border-top-style: solid !important;
      border-top-color: grey !important;
    }

    .list-group-item.active {
      background-color: #d1e0ff;
      color: black;
      border-color: #2a53f5;
      border-top-color: #2a53f5 !important;
    }

    .bg-light-1 {
      background: #f3f3f3 !important;
    }

    .display-5 {
      font-size: 2.5rem;
      font-weight: 300;
      line-height: 1.2;
    }

    .display-6 {
      font-size: 2.2rem;
      font-weight: 300;
      line-height: 1.2;
    }
  </style>
</head>

<body onload="updateList()">

  <nav class="navbar navbar-expand-sm navbar-light bg-light border-bottom mb-3">
    <a class="navbar-brand" href="#">Oak Grove Virtual Choir</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item disabled">
          <a class="nav-link" href="">Uploader<span class="sr-only">(current)</span></a>
        </li>
        <!--
        <li class="nav-item">
          <a class="nav-link" href="hymnal">Hymn Sheets</a>
        </li>
        -->
      </ul>
    </div>
  </nav>

  <div class="container bg-light-1 rounded-lg py-2 px-3 my-2">
    <h1 class="display-4">Uploader</h1>
    <hr class="my-4">
    <ol class="list-numbered">
      <li class="pb-2">
        Select hymn number and type in your name.
      </li>
      <li class="pb-2">Choose file. If you are on an iPhone or iPad, tap "Choose file" below, tap on the Photo Library button,
        find your video, select it, and wait until the "Compressing Video..." is complete. It will return you to this page once complete.
      </li>
      <li>
        Upload video and wait until completes the upload. It may take a minute or two to upload the video.
      </li>
    </ol>
  </div>
  
<hr size=1 width=150>
  
  <div class="container p-0">
    <form enctype="multipart/form-data" id="fileSubmit" novalidate>

      <ul class="list-group bg-light-1 rounded-lg py-2 px-3 mb-2 row-d-flex">
  
        <div class="display-6 pb-2">Pick what you are uploading:</div>        
        
        <br>
        
        <div class="display-7 pb-6">Hymns for September 13</div>
        <ul>
        <li class="list-group-item col-lg-5 my-2 p-2 rounded-lg border-top" id="0121">Hymn 121: There's a Wideness in God's Mercy</li>
        <li class="list-group-item col-lg-5 my-2 p-2 rounded-lg border-top" id="0600">Hymn 600: Wonderful Words of Life</li>
        </ul>
        
        <br>
        
        <ul>
        <div class="display-7 pb-6">Hymns for September 20</div>
        <li class="list-group-item col-lg-5 my-2 p-2 rounded-lg border-top" id="0129">Hymn 129: Give to the Winds Thy Fears</li>
        <li class="list-group-item col-lg-5 my-2 p-2 rounded-lg border-top" id="0452">Hymn 452: My Faith Looks Up to Thee</li>
        </ul>
        
        <br>
        
        <ul>
        <div class="display-7 pb-6">Children's Choir</div>
        <li class="list-group-item col-lg-5 my-2 p-2 rounded-lg border-top" id="ISeeYouGod">Anthem: I See You God</li>
        </ul>
        
        <br>
        
        <ul>
        <div class="display-7 pb-6">Other</div>
        <li class="list-group-item col-lg-5 my-2 p-2 rounded-lg border-top" id="Other">Something Else Not Listed Here</li>
        </ul>
        
      </ul>

<hr size=1 width=150>      
      
      <div class="container bg-light-1 mb-2 py-2 px-3 rounded-lg">
        <div class="display-6 pb-2">Type your name:</div>
        <input class="form-control form-control-lg" type="text" placeholder="Name" name="fullname" id="name" required>
        <div class="invalid-feedback">
          Please enter your name.
        </div>
      </div>

<hr size=1 width=150>       
      
      <div class="container bg-light-1 mb-2 py-2 px-3 rounded-lg">
        <div class="display-6 pb-2">Type the password:</div>
        <input class="form-control form-control-lg" type="password" placeholder="Password" id="pwd" required>
        <div class="alert alert-danger mt-3 mb-2 d-none" id="wrongPass" role="alert">
          Incorrect password, please try again.
        </div>

      </div>

<hr size=1 width=150>    
      
      <div class="container bg-light-1 mb-3 py-2 px-3 rounded-lg">
        <div class="display-6 pb-2">Select your video:</div>

        <input type="hidden" name="hymn">
        <div class="custom-file mb-3">
          <input type="file" class="custom-file-input mb-0 p-2" name="video" accept="video/*,audio/*" id="customFile">
          <label class="custom-file-label" for="customFile">Select hymn video...</label>
          <div class="invalid-feedback">
            Please select a video.
          </div>
        </div>
    </form>

    <div class="progress mt-3 mb-3 d-none" id="progressbar">
      <div class="progress-bar progress-bar-striped progress-bar-animated" id="uploadProgress" role="progressbar" style="width: 0%"></div>
    </div>
  </div>
    
<hr size=1 width=150>      
    
  <button type"button" class="display-6 col-12 mb-4 form-control-lg btn btn-primary" value="UPLOAD" id="submitButton">
    Upload
    <!-- <span class="spinner-border d-none" role="status" id="spin"></span> -->
  </button>

  </div>



  <!-- DO NOT TOUCH!!!!! -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
  <script type="text/javascript">
    // hymn chooser
    function updateList() {
      var items = document.getElementsByClassName("list-group-item active");
      $('[name=hymn]').val(items[0].id);
    };

    // hymn chooser
    $(function() {
      $('.list-group li').click(function(e) {
        e.preventDefault()
        $that = $(this);
        $that.parent().find('li').removeClass('active list-group-item-primary');
        $that.addClass('active list-group-item-primary');
        updateList();
      });
    })

    // choose file
    $('.custom-file-input').on('change', function() {
      let fileName = $(this).val().split('\\').pop();
      $(this).siblings('.custom-file-label').addClass('selected').html(fileName);
    });

    document.getElementById("submitButton").classList.add("disabled");

    var nameVar = document.getElementById("name");
    var isValidName = nameVar.checkValidity();
    var passVar = document.getElementById("pwd");
    var isValidPass = passVar.checkValidity();
    var fileVar = document.getElementById("customFile");
    var isValidFile = fileVar.checkValidity();
    var formVar = document.getElementById('fileSubmit');

    var isAuthenticated = false;
    var dist = 0;

    $('#submitButton').click(async function(event) {
      isValidPass = passVar.checkValidity();
      isValidName = nameVar.checkValidity();
      isValidFile = fileVar.checkValidity();
      if (!isValidFile || !isValidName || !isValidPass) {
        return;
      }
      await checkPwd($('#pwd').val());
    });

    function checkAuthAndSend() {
      if (!isAuthenticated) {
        document.getElementById("submitButton").classList.add("disabled");
        $("#wrongPass").removeClass("d-none");
        passVar.value = "";
        return;
      }
      $("#wrongPass").addClass("d-none");


      var data = new FormData();
      //Form data
      var form_data = $('#fileSubmit').serializeArray();
      $.each(form_data, function(key, input) {
        data.append(input.name, input.value);
      });

      //File data
      var file_data = $('input[name="video"]')[0].files;
      for (var i = 0; i < file_data.length; i++) {
        data.append("video[]", file_data[i]);
      }

      $.ajax({
        xhr: function() {
          var xhr = new window.XMLHttpRequest();
          //Upload progress
          xhr.upload.addEventListener("progress", function(evt) {
            if (evt.lengthComputable) {
              var percentComplete = evt.loaded / evt.total;
              percentComplete = percentComplete * 100;
              var width = parseFloat(percentComplete).toFixed(0) + "%";
              console.log("width: " + width);
              $("#uploadProgress").css("width", width);
              if (percentComplete >= 99.5) {
                $("#submitButton").html("Finalizing...");
              } else {
                $("#submitButton").html("Uploading: " + width);
              }
            }
          }, false);
          xhr.addEventListener("progress", function(evt) {
            if (evt.lengthComputable) {
              var percentComplete = evt.loaded / evt.total;
            }
          }, false);
          return xhr;
        },

        url: "upload.php",
        method: "post",
        processData: false,
        contentType: false,
        data: data,
        success: function(data) {
          $('body').html(data);
        },
        error: function(e) {
          $('body').html(e);
        }
      });
      isAuthenticated = false;
      $("#progressbar").removeClass("d-none");
      $("#submitButton").html("Uploading...");
    }


    async function checkPwd(passToCheck) {
      var getParams = 'pwd=';
      getParams = getParams.concat(passToCheck);
      $.get("hashes.php", getParams, "json")
        .done(function(data) {
          var reply = $.parseJSON(data);
          isAuthenticated = reply.authenticated;
          checkAuthAndSend();
        });
    };

    nameVar.addEventListener('keyup', function(event) {
      isValidName = nameVar.checkValidity();
      isValidPass = passVar.checkValidity();
      isValidFile = fileVar.checkValidity();
      if (!isValidName) {
        document.getElementById("submitButton").classList.add("disabled");
      } else {
        if (isValidPass && isValidFile) {
          document.getElementById("submitButton").classList.remove("disabled");
        }
      }
    });

    passVar.addEventListener('keyup', function(event) {
      isValidPass = passVar.checkValidity();
      isValidName = nameVar.checkValidity();
      isValidFile = fileVar.checkValidity();
      if (!isValidPass) {
        document.getElementById("submitButton").classList.add("disabled");
      } else {
        $("#wrongPass").addClass("d-none");
        if (isValidName && isValidFile) {
          document.getElementById("submitButton").classList.remove("disabled");
        }
      }
    });

    fileVar.addEventListener('change', function(event) {
      isValidFile = fileVar.checkValidity();
      isValidName = nameVar.checkValidity();
      isValidPass = passVar.checkValidity();
      if (!isValidFile) {
        document.getElementById("submitButton").classList.add("disabled");
      } else {
        $("#wrongPass").addClass("d-none");
        if (isValidName && isValidPass)
          document.getElementById("submitButton").classList.remove("disabled");
      }
    });

    $("#testbutton").click(function() {
      $("#spin").removeClass("d-none");
      $("#name").val(dist);
    });
  </script>

</body>

</html>
